<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI Social Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern Color Palette */
            --primary: #6366f1;
            /* Indigo */
            --primary-hover: #4f46e5;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Header Styling */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        h2,
        h3 {
            color: #374151;
            margin-top: 0;
        }

        /* Card Component */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        /* Inputs */
        input,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 0.95rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Buttons */
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .btn-danger {
            background-color: #fee2e2;
            color: var(--danger);
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-danger:hover {
            background-color: #fecaca;
        }

        .btn-download {
            background-color: #d1fae5;
            color: var(--success);
            padding: 6px 12px;
            font-size: 0.8rem;
            text-decoration: none;
            display: inline-block;
            border-radius: 6px;
        }

        .btn-download:hover {
            background-color: #a7f3d0;
        }

        .btn-vote {
            display: flex;
            align-items: center;
            gap: 5px;
            background: transparent;
            color: var(--text-muted);
            padding: 6px 10px;
        }

        .btn-vote:hover {
            color: var(--primary);
            background: #e0e7ff;
            border-radius: 6px;
        }

        .active-tab {
            background-color: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }

        /* Helper Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .flex-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meta-text {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .username-tag {
            font-weight: 600;
            color: var(--primary);
        }

        /* Auth Screen */
        .auth-container {
            max-width: 400px;
            margin: 80px auto;
        }

        .link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9rem;
        }

        /* Item Lists */
        .item-list {
            border-top: 1px solid var(--border);
            margin-top: 15px;
        }

        .item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .item:last-child {
            border-bottom: none;
        }

        .upload-section {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="auth-section" class="auth-container">
        <div class="card text-center">
            <h2 id="auth-title" style="margin-bottom: 20px;">Welcome Back</h2>
            <input type="email" id="email" placeholder="Email Address">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" onclick="handleAuth()" style="margin-top: 10px;">Login</button>
            <p style="margin-top: 15px;">
                <span id="auth-toggle-text" class="link" onclick="toggleAuthMode()">Need an account? Register</span>
            </p>
            <div id="error-msg" style="color: var(--danger); font-size: 0.9rem; margin-top: 10px;"></div>
        </div>
    </div>

    <div id="app-section" class="container hidden">
        <header>
            <h1>üî• Social Hub</h1>
            <div>
                <span style="margin-right: 15px; font-weight: 500;" id="user-display">User</span>
                <button class="btn-outline" onclick="logout()">Logout</button>
            </div>
        </header>

        <div style="display: flex; gap: 10px; margin-bottom: 25px;">
            <button class="btn-outline active-tab" onclick="switchTab('posts')" id="tab-posts"
                style="flex:1;">Feed</button>
            <button class="btn-outline" onclick="switchTab('files')" id="tab-files" style="flex:1;">Files</button>
        </div>

        <div id="view-posts">
            <div class="card">
                <input type="text" id="post-title" placeholder="Give your post a title..." style="font-weight: bold;">
                <textarea id="post-content" rows="2" placeholder="What's on your mind?"></textarea>
                <div style="text-align: right;">
                    <button class="btn-primary" style="width: auto;" onclick="createPost()">Publish Post</button>
                </div>
            </div>

            <div id="posts-container"></div>
        </div>

        <div id="view-files" class="hidden">
            <div class="card">
                <h3>Upload New File</h3>
                <div class="upload-section">
                    <input type="file" id="file-input" style="border: none; margin: 0;">
                    <button class="btn-primary" style="width: auto; margin-top: 10px;" onclick="uploadFile()">Click to
                        Upload</button>
                </div>
            </div>

            <div class="card">
                <div class="flex-row">
                    <h3>My Files</h3>
                    <button class="btn-outline" id="toggle-files-btn" onclick="toggleFileList()">Show My Files</button>
                </div>

                <div id="file-list-wrapper" class="hidden item-list">
                    <div id="files-container">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const API_URL = "https://example-fastapi-1rwn.onrender.com"; // Replace with Render URL in production
        let token = localStorage.getItem("token");
        let isLoginMode = true;

        // INIT
        if (token) {
            initApp();
        }

        function initApp() {
            document.getElementById("auth-section").classList.add("hidden");
            document.getElementById("app-section").classList.remove("hidden");
            document.getElementById("user-display").innerText = "Logged In"; // You can decode JWT to get real email if you want
            fetchPosts();
        }

        // AUTH LOGIC
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById("auth-title").innerText = isLoginMode ? "Welcome Back" : "Create Account";
            document.getElementById("auth-toggle-text").innerText = isLoginMode ? "Need an account? Register" : "Have an account? Login";
        }

        async function handleAuth() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const errBox = document.getElementById("error-msg");
            errBox.innerText = "";

            try {
                if (isLoginMode) {
                    const formData = new FormData();
                    formData.append("username", email);
                    formData.append("password", password);

                    const res = await fetch(`${API_URL}/login`, { method: "POST", body: formData });
                    if (!res.ok) throw new Error("Invalid credentials");

                    const data = await res.json();
                    localStorage.setItem("token", data.access_token);
                    token = data.access_token;
                    initApp();
                } else {
                    const res = await fetch(`${API_URL}/users/`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email, password })
                    });
                    if (!res.ok) throw new Error("Registration failed");
                    alert("Account created! Please login.");
                    toggleAuthMode();
                }
            } catch (err) {
                errBox.innerText = err.message;
            }
        }

        function logout() {
            localStorage.removeItem("token");
            location.reload();
        }

        // TABS
        function switchTab(tab) {
            document.getElementById("view-posts").classList.add("hidden");
            document.getElementById("view-files").classList.add("hidden");
            document.getElementById("tab-posts").classList.remove("active-tab");
            document.getElementById("tab-files").classList.remove("active-tab");

            document.getElementById(`view-${tab}`).classList.remove("hidden");
            document.getElementById(`tab-${tab}`).classList.add("active-tab");
        }

        // --- POSTS ---
        async function fetchPosts() {
            const res = await fetch(`${API_URL}/posts/`, { headers: { "Authorization": `Bearer ${token}` } });
            const posts = await res.json();
            const container = document.getElementById("posts-container");
            container.innerHTML = "";

            posts.forEach(postData => {
                // Adjust depending on if your API returns {Post: {}, votes: 0} or just Post
                const p = postData.Post ? postData.Post : postData;
                const votes = postData.votes !== undefined ? postData.votes : 0;

                // Use owner email if available, otherwise owner_id
                const ownerName = p.owner ? p.owner.email.split('@')[0] : `User ${p.owner_id}`;

                const html = `
                    <div class="card item">
                        <div style="flex:1;">
                            <div class="meta-text"><span class="username-tag">@${ownerName}</span> ‚Ä¢ ${new Date(p.created_at).toLocaleDateString()}</div>
                            <h3 style="margin: 8px 0; font-size: 1.2rem;">${p.title}</h3>
                            <p style="color: #4b5563;">${p.content}</p>
                            <div style="margin-top: 10px;">
                                <button class="btn-vote" onclick="votePost(${p.id})">
                                    ‚ù§Ô∏è ${votes} Likes
                                </button>
                            </div>
                        </div>
                        <div style="margin-left: 10px;">
                            <button class="btn-danger" onclick="deletePost(${p.id})">Delete</button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        async function createPost() {
            const title = document.getElementById("post-title").value;
            const content = document.getElementById("post-content").value;

            await fetch(`${API_URL}/posts/`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ title, content, published: true })
            });

            document.getElementById("post-title").value = "";
            document.getElementById("post-content").value = "";
            fetchPosts();
        }

        async function deletePost(id) {
            if (!confirm("Are you sure?")) return;
            const res = await fetch(`${API_URL}/posts/${id}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (res.ok) fetchPosts();
            else alert("Cannot delete other people's posts!");
        }

        async function votePost(id) {
            await fetch(`${API_URL}/votes/`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ post_id: id, dir: 1 })
            });
            fetchPosts();
        }

        // --- FILES ---

        // Toggle Logic
        function toggleFileList() {
            const wrapper = document.getElementById("file-list-wrapper");
            const btn = document.getElementById("toggle-files-btn");

            if (wrapper.classList.contains("hidden")) {
                wrapper.classList.remove("hidden");
                btn.innerText = "Hide Files";
                fetchFiles(); // Load data only when opened
            } else {
                wrapper.classList.add("hidden");
                btn.innerText = "Show My Files";
            }
        }

        async function fetchFiles() {
            const res = await fetch(`${API_URL}/files/`, { headers: { "Authorization": `Bearer ${token}` } });
            const files = await res.json();
            const container = document.getElementById("files-container");
            container.innerHTML = "";

            if (files.length === 0) {
                container.innerHTML = "<p class='text-center text-muted'>No files uploaded yet.</p>";
                return;
            }

            files.forEach(file => {
                // Get username safely
                const ownerName = file.owner ? file.owner.email.split('@')[0] : `User ${file.owner_id || '?'}`;

                const html = `
                    <div class="item">
                        <div>
                            <div style="font-weight: 600; font-size: 1rem;">${file.filename}</div>
                            <div class="meta-text">Uploaded by <span class="username-tag">${ownerName}</span></div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-download" onclick="downloadFile(${file.id}, '${file.filename}')">Download</button>
                            <button class="btn-danger" onclick="deleteFile(${file.id})">Delete</button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        async function uploadFile() {
            const input = document.getElementById("file-input");
            if (!input.files[0]) return alert("Please select a file first!");

            const formData = new FormData();
            formData.append("file", input.files[0]);

            const res = await fetch(`${API_URL}/files/`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` },
                body: formData
            });

            if (res.ok) {
                alert("Upload Successful!");
                // If list is open, refresh it
                if (!document.getElementById("file-list-wrapper").classList.contains("hidden")) {
                    fetchFiles();
                }
            } else {
                alert("Upload Failed");
            }
        }

        async function downloadFile(id, filename) {
            const res = await fetch(`${API_URL}/files/download/${id}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
            } else {
                alert("You are not authorized to download this file.");
            }
        }

        async function deleteFile(id) {
            if (!confirm("Permanently delete this file?")) return;
            const res = await fetch(`${API_URL}/files/${id}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) fetchFiles();
            else alert("You cannot delete this file.");
        }
    </script>
</body>

</html>