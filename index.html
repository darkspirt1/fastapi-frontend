<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialHub Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --text-main: #111827;
            --text-sub: #6B7280;
            --border: #E5E7EB;
            --danger: #EF4444;
            --success: #10B981;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        /* --- AUTH SECTION --- */
        #auth-container {
            width: 100%;
            max-width: 400px;
            padding: 40px 20px;
            align-self: center;
        }

        .auth-card {
            background: var(--surface);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
        }

        .btn-full {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1rem;
        }

        .link {
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 15px;
            display: block;
            text-decoration: underline;
        }

        /* --- APP LAYOUT --- */
        #app-container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            overflow: hidden;
        }

        aside {
            width: 260px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-sub);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #EEF2FF;
            color: var(--primary);
        }

        main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border);
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            color: var(--text-sub);
            transition: 0.2s;
            margin-right: 5px;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            background: #F3F4F6;
            color: var(--text-main);
        }

        .btn-del:hover {
            background: #FEE2E2;
            color: var(--danger);
            border-color: var(--danger);
        }

        .btn-down:hover {
            background: #D1FAE5;
            color: var(--success);
            border-color: var(--success);
        }

        .btn-like {
            color: var(--primary);
            border-color: #EEF2FF;
            background: #EEF2FF;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            background: #F9FAFB;
            margin-bottom: 30px;
        }

        .upload-input {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin: 5px;
            width: 100%;
            max-width: 400px;
        }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            transform: translateY(20px);
        }

        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .hidden {
            display: none !important;
        }

        .user-tag {
            background: #E5E7EB;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #4B5563;
            margin-left: 8px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div id="toast">Success</div>

    <div id="auth-container">
        <div class="auth-card">
            <h2 id="auth-title">Welcome Back</h2>
            <p style="color:var(--text-sub); margin-bottom:20px;">Please enter your details</p>

            <input type="email" id="email" class="auth-input" placeholder="Email Address">
            <input type="password" id="password" class="auth-input" placeholder="Password">

            <button class="btn-full" onclick="handleAuth()" id="auth-btn">Log In</button>

            <span class="link" onclick="toggleAuth()" id="auth-toggle">New here? Create an account</span>

            <p id="auth-error" style="color:red; font-size:0.9rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <aside>
            <div class="logo"><i class="ph ph-share-network"></i> SocialHub</div>
            <div class="nav-item active" onclick="nav('feed')" id="nav-feed"><i class="ph ph-newspaper"></i> Feed</div>
            <div class="nav-item" onclick="nav('files')" id="nav-files"><i class="ph ph-folder-open"></i> All Files
            </div>
            <div style="flex:1;"></div>
            <div class="nav-item" onclick="logout()"><i class="ph ph-sign-out"></i> Log Out</div>
        </aside>

        <main>
            <div class="header">
                <h2 id="page-title">Global Feed</h2>
                <div id="user-display" style="font-weight:600; color:var(--text-sub);">User</div>
            </div>

            <div id="view-feed">
                <div class="card">
                    <input type="text" id="post-title" class="auth-input" style="width:100%;" placeholder="Post Title">
                    <textarea id="post-content" class="auth-input" style="width:100%;" rows="2"
                        placeholder="Message..."></textarea>
                    <button class="btn-full" style="width:auto; padding:8px 20px;" onclick="createPost()">Post</button>
                </div>
                <div id="feed-list"></div>
            </div>

            <div id="view-files" class="hidden">
                <div class="upload-zone">
                    <i class="ph ph-cloud-arrow-up" style="font-size: 2rem; color: var(--primary);"></i>
                    <h3>Upload to Public Storage</h3>
                    <div>
                        <input type="file" id="file-upload" class="upload-input">
                    </div>
                    <button class="btn-full" style="width:auto; padding:8px 30px;"
                        onclick="uploadFile()">Upload</button>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3>All Uploaded Files</h3>
                        <button class="action-btn" onclick="fetchFiles()"><i
                                class="ph ph-arrows-clockwise"></i></button>
                    </div>
                    <div id="files-list">Loading...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // CONFIG
        const API_URL = "https://example-fastapi-1rwn.onrender.com"; // CHANGE THIS FOR RENDER

        let token = localStorage.getItem("token");
        let currentUserEmail = "";
        let isLoginMode = true; // Track if user is Logging in or Registering

        if (token) startApp();

        function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }

        function startApp() {
            const payload = parseJwt(token);
            if (payload) currentUserEmail = payload.sub;
            document.getElementById("user-display").innerText = currentUserEmail;

            document.getElementById("auth-container").classList.add("hidden");
            document.getElementById("app-container").classList.remove("hidden");
            nav('feed');
        }

        // --- AUTH LOGIC (Updated) ---
        function toggleAuth() {
            isLoginMode = !isLoginMode;
            // Update UI text based on mode
            document.getElementById("auth-title").innerText = isLoginMode ? "Welcome Back" : "Create Account";
            document.getElementById("auth-btn").innerText = isLoginMode ? "Log In" : "Register";
            document.getElementById("auth-toggle").innerText = isLoginMode ? "New here? Create an account" : "Have an account? Log In";
            document.getElementById("auth-error").innerText = "";
        }

        async function handleAuth() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const errBox = document.getElementById("auth-error");

            if (!email || !password) {
                errBox.innerText = "Please enter email and password";
                return;
            }

            try {
                if (isLoginMode) {
                    // LOGIN FLOW
                    const formData = new FormData();
                    formData.append("username", email);
                    formData.append("password", password);

                    const res = await fetch(`${API_URL}/login`, { method: "POST", body: formData });
                    if (res.ok) {
                        const data = await res.json();
                        token = data.access_token;
                        localStorage.setItem("token", token);
                        startApp();
                    } else {
                        errBox.innerText = "Invalid credentials. Try again.";
                    }
                } else {
                    // CREATE USER FLOW
                    const res = await fetch(`${API_URL}/users/`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email: email, password: password })
                    });

                    if (res.ok) {
                        showToast("Account Created! Please Log In.");
                        toggleAuth(); // Switch back to login screen
                    } else {
                        errBox.innerText = "Registration failed (Email might be taken).";
                    }
                }
            } catch (e) { errBox.innerText = e.message; }
        }

        function logout() { localStorage.clear(); location.reload(); }

        // --- NAVIGATION ---
        function nav(view) {
            document.getElementById("view-feed").classList.add("hidden");
            document.getElementById("view-files").classList.add("hidden");
            document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));

            document.getElementById(`view-${view}`).classList.remove("hidden");
            document.getElementById(`nav-${view}`).classList.add("active");
            document.getElementById("page-title").innerText = view === 'feed' ? "Global Feed" : "Public File Storage";

            if (view === 'feed') fetchFeed();
            if (view === 'files') fetchFiles();
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg; t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 3000);
        }

        // --- POSTS (Shows User Name) ---
        async function fetchFeed() {
            const list = document.getElementById("feed-list");
            const res = await fetch(`${API_URL}/posts/`, { headers: { "Authorization": `Bearer ${token}` } });
            const posts = await res.json();
            list.innerHTML = "";
            posts.forEach(p => {
                const post = p.Post ? p.Post : p;
                const votes = p.votes !== undefined ? p.votes : 0;

                // Show User Email instead of ID
                const ownerName = post.owner ? post.owner.email : `User ${post.owner_id}`;

                list.innerHTML += `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <h3 style="margin:0;">
                                ${post.title} 
                                <span class="user-tag">@${ownerName}</span>
                            </h3>
                            <p style="color:var(--text-sub); margin-top:5px;">${post.content}</p>
                        </div>
                    </div>
                    
                    <div style="margin-top:15px; display:flex; gap:5px; align-items:center;">
                        <button class="action-btn btn-like" onclick="vote(${post.id}, 1)">
                            <i class="ph ph-thumbs-up"></i> ${votes} Likes
                        </button>
                        <button class="action-btn" onclick="vote(${post.id}, 0)" title="Dislike">
                            <i class="ph ph-thumbs-down"></i>
                        </button>
                    </div>
                </div>`;
            });
        }

        async function createPost() {
            const title = document.getElementById("post-title").value;
            const content = document.getElementById("post-content").value;
            await fetch(`${API_URL}/posts/`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ title, content, published: true })
            });
            document.getElementById("post-title").value = "";
            document.getElementById("post-content").value = "";
            fetchFeed();
        }

        async function vote(id, direction) {
            try {
                const res = await fetch(`${API_URL}/votes/`, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ post_id: id, dir: direction })
                });
                if (res.ok) fetchFeed();
                else showToast(direction === 0 ? "Not liked yet!" : "Already liked!");
            } catch (e) { console.error(e); }
        }

        // --- FILES (No Rename Option) ---
        async function fetchFiles() {
            const list = document.getElementById("files-list");
            list.innerHTML = "Loading...";

            const res = await fetch(`${API_URL}/files/`, { headers: { "Authorization": `Bearer ${token}` } });
            const files = await res.json();

            list.innerHTML = "";
            if (files.length === 0) return list.innerHTML = "<p style='text-align:center; color:#999;'>No files yet.</p>";

            files.forEach(f => {
                const ownerEmail = f.owner ? f.owner.email : "Unknown";
                const isMine = ownerEmail === currentUserEmail;
                const deleteBtn = isMine ? `<button class="action-btn btn-del" onclick="deleteFile(${f.id})"><i class="ph ph-trash"></i></button>` : '';

                list.innerHTML += `
                <div class="file-item">
                    <div>
                        <div style="font-weight:600;">${f.filename}</div>
                        <div style="font-size:0.8rem; color:var(--text-sub);">Uploaded by: ${ownerEmail}</div>
                    </div>
                    <div>
                        <button class="action-btn btn-down" onclick="downloadFile(${f.id}, '${f.filename}')"><i class="ph ph-download-simple"></i></button>
                        ${deleteBtn}
                    </div>
                </div>`;
            });
        }

        async function uploadFile() {
            const input = document.getElementById("file-upload");
            if (!input.files[0]) return showToast("Select file first");

            const formData = new FormData();
            formData.append("file", input.files[0]);

            const res = await fetch(`${API_URL}/files/`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` },
                body: formData
            });

            if (res.ok) { showToast("Uploaded!"); fetchFiles(); }
            else showToast("Upload Failed");
        }

        async function downloadFile(id, name) {
            const res = await fetch(`${API_URL}/files/download/${id}`, { headers: { "Authorization": `Bearer ${token}` } });
            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = name;
                document.body.appendChild(a); a.click(); a.remove();
            } else showToast("Download failed");
        }

        async function deleteFile(id) {
            if (!confirm("Delete this file?")) return;
            const res = await fetch(`${API_URL}/files/${id}`, { method: "DELETE", headers: { "Authorization": `Bearer ${token}` } });
            if (res.ok) { showToast("Deleted"); fetchFiles(); }
        }
    </script>
</body>

</html>